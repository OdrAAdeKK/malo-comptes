{% extends 'base.html' %}

{% import '_macros.html' as m %}



{% block title %}Concerts archiv√©s - Saison {{ saison }}{% endblock %}
{% block body_class %}big-mode{% endblock %}

{% block content %}
<div class="container" style="margin-top:24px;">
  <h1>Concerts archiv√©s ‚Äî Saison {{ saison }}</h1>

  {% if groupes %}
    {% for key, bloc in groupes.items() %}
      <h2 class="mois-bandeau">{{ bloc.label }}</h2>

      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Lieu</th>
            <th>Recette</th>
            <th>Frais</th>
            <th>Pay√©</th>
            <th>Participants / Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for concert in bloc["items"] %}
            <tr>
              <td>{{ concert.date.strftime('%d/%m/%Y') }}</td>
			{# Lieu cliquable si une fiche est li√©e #}
			{% if concert.lieu_obj %}
			  {% set lieu_label = concert.lieu_obj.nom
				 ~ ((' ‚Äî ' ~ concert.lieu_obj.organisme) if concert.lieu_obj.organisme else '')
				 ~ ((' ‚Äî ' ~ concert.lieu_obj.ville) if concert.lieu_obj.ville else '') %}
			{% else %}
			  {% set lieu_label = concert.lieu or '' %}
			{% endif %}

			<td class="col-lieu">
			  {% if concert.lieu_id %}
				<a class="link-lieu" href="{{ url_for('fiche_lieu', lieu_id=concert.lieu_id) }}">{{ lieu_label }}</a>
			  {% else %}
				{{ lieu_label }}
			  {% endif %}
			</td>

              <td>{{ concert.recette | format_currency if concert.recette is not none else '' }}</td>
              <td>{{ concert.frais | format_currency if concert.frais is not none else '' }}</td>
              <td style="text-align:center;">
                <input
                  type="checkbox"
                  class="paye-checkbox"
                  data-id="{{ concert.id }}"
                  title="Cocher/d√©cocher le statut pay√©"
                  {% if concert.paye %}checked{% endif %}
                  {% if readonly_checkboxes %}disabled{% endif %}>
              </td>
              <td>
				{% if credits_musiciens.get(concert.id) %}
				  <div class="credits" style="font-size:0.97em; margin-bottom:8px;">
					<strong>Participants&nbsp;:</strong>
					<ul style="margin:6px 0 4px 16px; padding-left:0;">
						{% set fpm = frais_par_musicien.get(concert.id, {}) if frais_par_musicien else {} %}
						{% for mid, credit in credits_musiciens[concert.id].items() %}
						  {% set m = musiciens_dict[mid] %}
						  {% set frais_val = fpm.get(mid) %}
						  <li>
							{{ m.prenom }} {{ m.nom }} : {{ credit | format_currency }}
							{% if frais_val is not none and frais_val != 0 %}
							  <div class="frais-note">frais : {{ (frais_val | float) | abs | format_currency }}</div>
							{% endif %}
						  </li>
						{% endfor %}

					  <li style="font-weight:600; color:#673ab7;">
						ASSO7&nbsp;: {{ credits_asso7[concert.id] | format_currency }}
					  </li>
					</ul>
				  </div>
				{% endif %}


				<div class="actions">
				  <!-- ‚öñÔ∏è Ajustements / gains fixes -->
				  <a href="#" class="adjust-button" data-id="{{ concert.id }}" title="Ajuster / fixer des gains">‚öñÔ∏è</a>

				  <a href="{{ url_for('modifier_concert', concert_id=concert.id, next=request.full_path) }}" class="edit-button" title="Modifier">‚úèÔ∏è</a>
				  <a href="{{ url_for('liste_participations', concert_id=concert.id) }}" class="participation-button" title="Participations">üë•</a>

				  <!-- üóëÔ∏è Supprimer d√©finitivement le concert (et ses op√©rations/participations) -->
				  <form method="post"
						action="{{ url_for('supprimer_concert', concert_id=concert.id) }}"
						onsubmit="return confirm('Supprimer d√©finitivement ce concert et toutes ses op√©rations/participations ?');"
						style="display:inline;">
					<button type="submit" class="delete-button" title="Supprimer d√©finitivement">üóëÔ∏è</button>
				  </form>
				</div>

              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endfor %}
  {% else %}
    <p>Aucun concert archiv√© pour cette saison.</p>
  {% endif %}

  <div class="button-row-concerts">
    <a href="{{ url_for('accueil') }}" class="back-button">Accueil</a>
    <a href="{{ url_for('archives_concerts') }}" class="archives-button">‚Üê Saisons</a>
  </div>
</div>

{% include "_popup_ajustements.html" %}
<script src="{{ url_for('static', filename='js/popup_ajustements.js') }}"></script>

<style>
  .container { background:white; padding:30px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); max-width:1200px; }
  .mois-bandeau { background:#fde7e7; padding:10px 14px; border-radius:8px; margin:24px 0 8px; }
  table { width:100%; border-collapse:collapse; }
  th, td { padding:10px; border-bottom:1px solid #ddd; text-align:left; }
  th { background:#4285f4; color:white; }
  tr:hover { background:#f9fafb; }
  .actions a { margin-right:6px; text-decoration:none; }

  /* Boutons harmonis√©s */
  .adjust-button, .edit-button, .participation-button {

.delete-button {
  background:#dc2626;
  color:#fff;
  border:none;
  padding:6px 10px;
  border-radius:5px;
  font-weight:600;
  cursor:pointer;
}
.delete-button:hover { background:#b91c1c; }

    padding:6px 10px; border-radius:5px; color:#fff; font-weight:500;
  }
  .adjust-button{ background:#6d28d9; }        .adjust-button:hover{ background:#5b21b6; }
  .edit-button{ background:#f9a825; }          .edit-button:hover{ background:#f57f17; }
  .participation-button{ background:#4285f4; } .participation-button:hover{ background:#3367d6; }
  
  
  .link-lieu { text-decoration: underline; text-underline-offset: 2px; color: inherit; }
.link-lieu:hover { color: #0e6655; }

</style>

<script>
  // (D√©)cocher "Pay√©" depuis les archives
  document.querySelectorAll('.paye-checkbox').forEach(function(box) {
    box.addEventListener('change', function() {
      const concertId = this.dataset.id;

      // On g√®re surtout la d√©-coche (retour en non-pay√©)
      if (!this.checked) {
        if (!confirm("Annuler la validation du paiement pour ce concert ?")) {
          this.checked = true;
          return;
        }
        fetch("/annuler_paiement_concert", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ concert_id: Number(concertId) })
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            // La page archives n'affiche que des concerts pay√©s : on recharge.
            location.reload();
          } else {
            alert("Erreur : " + (data.message || "inconnue"));
            this.checked = true;
          }
        })
        .catch(() => { alert("Erreur r√©seau"); this.checked = true; });
      } else {
        // Re-cocher depuis les archives -> on bloque (optionnel)
        this.checked = false;
      }
    });
  });
</script>

<style>
  .frais-note{
    font-size:.85em;
    color:#6b7280;
    font-style:italic;
    margin-left:4px;
  }
</style>

{% endblock %}
