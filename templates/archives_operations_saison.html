{% extends 'base.html' %}

{% block title %}Op√©rations archiv√©es - Saison {{ saison }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/archives_operations.css') }}">
<style>
  /* √âtat pr√©visionnel + micro-styles */
  tr.is-previsionnel { background: #fafafa; }
  .muted-italic { color: #6b7280; font-style: italic; }
  .prev-tag { color: #6b7280; font-style: italic; margin-left: 6px; font-size: .9em; }

  /* Cadre + tableau */
  .container.archives-ops { max-width: 1200px; width: 100%; }
  .container.archives-ops .archived-table { width: 100%; table-layout: auto; border-collapse: collapse; }

  /* ‚úÖ Emp√™che l‚Äôempilement visuel : ligne confortable partout */
  .container.archives-ops .archived-table th,
  .container.archives-ops .archived-table td {
    line-height: 1.35;          /* <- cl√© du probl√®me */
    vertical-align: middle;      /* ou 'top' si tu pr√©f√®res */
    white-space: normal;         /* reset */
  }

  /* Col. Montant (6) : ~12,5 caract√®res, non-wrap + chiffres tabulaires */
  .container.archives-ops .archived-table th:nth-child(6),
  .container.archives-ops .archived-table td:nth-child(6) {
    width: 12.5ch;
    min-width: 12.5ch;
    max-width: 12.5ch;
    white-space: nowrap;
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  /* R√©√©quilibrage : Qui / Motif / Pr√©cision / Concert */
  .container.archives-ops .archived-table th:nth-child(2),
  .container.archives-ops .archived-table td:nth-child(2) { /* Qui */
    width: 18%;
  }
  .container.archives-ops .archived-table th:nth-child(4),
  .container.archives-ops .archived-table td:nth-child(4) { /* Motif */
    width: 14%;
  }
  .container.archives-ops .archived-table th:nth-child(5),
  .container.archives-ops .archived-table td:nth-child(5) { /* Pr√©cision */
    width: 22%;
    word-break: break-word;
  }
  .container.archives-ops .archived-table th:nth-child(7),
  .container.archives-ops .archived-table td:nth-child(7) { /* Concert */
    width: 28%;
  }

  /* Actions : √©troit et centr√© */
  .container.archives-ops .archived-table th:nth-child(8),
  .container.archives-ops .archived-table td:nth-child(8) {
    width: 8%;
    text-align: center;
  }
</style>



<div class="container archives-ops">
  <h1>Op√©rations archiv√©es - Saison {{ saison }}</h1>
  <button onclick="ouvrirPopupRecherche()" title="Rechercher une op√©ration" style="background:none; border:none; cursor:pointer;">üîç Recherche par montant</button>

  {% if groupes and groupes|length > 0 %}
    {% for key, bloc in groupes.items() %}
      <h2 class="mois-bandeau">{{ bloc.label }}</h2>

      <table class="archived-table" data-month-key="{{ key }}">
		<thead>
		  <tr>
			<th id="sort-date-{{ loop.index }}" style="cursor:pointer;">Date ‚¨ç</th>
			<th id="sort-qui-{{ loop.index }}" style="cursor:pointer;">Qui ‚¨ç</th>
			<th>Type</th>
			<th>Motif</th>
			<th>Pr√©cision</th>
			<th id="sort-montant-{{ loop.index }}" style="cursor:pointer; text-align:right;">Montant ‚¨ç</th>
			<th id="sort-concert-{{ loop.index }}" style="cursor:pointer;">Concert ‚¨ç</th>
			<th style="text-align: center;">Actions</th>
		  </tr>
		</thead>

        <tbody>
          {% for op in bloc["items"] %}
            {% set motif_lower = (op.motif or '')|lower %}
            {% set type_lower = (op.type or '')|lower %}
            <tr class="{% if motif_lower == 'commission lionel' %}operation-auto {% endif %}{% if op.previsionnel %}is-previsionnel{% endif %}">
              <td>
                {{ op.date.strftime('%d/%m/%Y') }}
                {% if op.previsionnel %}<em class="prev-tag">(pr√©visionnel)</em>{% endif %}
              </td>
              <td>{{ op.musicien.prenom }} {{ op.musicien.nom }}</td>
              <td>{{ op.type }}</td>
              <td>{{ op.motif }}</td>
              <td>{{ op.precision or '' }}</td>
              <td style="text-align:right;">
                {% if type_lower == 'credit' %}+{% else %}-{% endif %}
                <span class="{% if op.previsionnel %}muted-italic{% endif %}">
                  {{ op.montant | format_currency }}
                </span>
              </td>
              <td>
                {% if op.concert %}
                  {{ op.concert.date.strftime('%d/%m/%Y') }} ‚Äî {{ op.concert.lieu }}
                {% else %}‚Äî{% endif %}
              </td>
              <td style="text-align: center;">
                {% if not op.auto_cb_asso7 and not op.auto_debit_salaire and motif_lower != 'commission lionel' %}
                  <form method="GET" action="{{ url_for('modifier_operation', id=op.id) }}" style="display:inline;">
                    <button type="submit" class="icon-button orange" title="Modifier">
                      <i class="fas fa-pen"></i>
                    </button>
                  </form>
                  <form method="POST" action="{{ url_for('supprimer_operation') }}" style="display:inline;" data-id="{{ op.id }}">
                    <button type="submit" class="delete-operation-button" title="Supprimer cette op√©ration">üóë</button>
                  </form>
                {% else %}
                  <span title="Op√©ration automatique non modifiable">üîí</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endfor %}

    <button id="btn-retour-liste" style="display:none; margin-top: 20px;" onclick="retourListe()">üîÅ Retour √† la liste compl√®te</button>
  {% else %}
    <p>Aucune op√©ration enregistr√©e pour cette saison.</p>
  {% endif %}

  <div class="button-row">
    <a href="{{ url_for('accueil') }}" class="back-button">Accueil</a>
    <a href="#" onclick="if (document.referrer) { window.history.back(); } else { window.location.href='{{ url_for('accueil') }}'; }" class="retour-button">‚¨Ö Retour</a>
    <a href="{{ url_for('page_archives') }}" class="archives-button">Archives</a>
    <a href="{{ url_for('operations_a_venir') }}" class="a-venir-button">√Ä venir</a>
    <a href="{{ url_for('operations') }}" class="operations-button">Nouvelle op√©ration</a>
  </div>
</div>

{% include '_popup_recherche.html' %}

<script src="{{ url_for('static', filename='js/supprimer_operation.js') }}"></script>
<script src="{{ url_for('static', filename='js/recherche_operations.js') }}"></script>

<script>
/**
 * Normalise une cha√Æne pour un tri alpha robuste (minuscule, sans accents, trim).
 */
function norm(s) {
  return (s || "")
    .toString()
    .normalize('NFD').replace(/\p{Diacritic}/gu,'')
    .toLowerCase()
    .trim();
}

/**
 * Extrait la cl√© de tri selon le type:
 * - date: parse "JJ/MM/AAAA"
 * - amount: nombre en tenant compte des +/‚àí, espaces et "‚Ç¨"
 * - text: alpha simple
 * - concert: on ignore la date "JJ/MM/AAAA ‚Äî " et on trie sur le libell√© du lieu
 */
function sortKeyFromCell(td, type) {
  const raw = (td.innerText || td.textContent || '').trim();

  if (type === 'date') {
    // "JJ/MM/AAAA"
    const m = raw.match(/^(\d{2})\/(\d{2})\/(\d{4})/);
    if (!m) return -Infinity;
    return new Date(`${m[3]}-${m[2]}-${m[1]}`).getTime();
  }

  if (type === 'amount') {
    return parseFloat(
      raw
        .replace(/\s/g,'')
        .replace('‚Ç¨','')
        .replace(',', '.')
        .replace(/[^\d.\-+]/g,'')
    ) || 0;
  }

  if (type === 'concert') {
    if (raw === '‚Äî' || raw === '-') return '';
    // "JJ/MM/AAAA ‚Äî Lieu"
    const parts = raw.split('‚Äî');
    const lieu  = (parts.length > 1 ? parts.slice(1).join('‚Äî') : raw);
    return norm(lieu);
  }

  // text par d√©faut
  return norm(raw);
}

/**
 * Trie un tableau HTML par colonne et type.
 */
function sortTableByColumn(table, columnIndex, type) {
  const tbody = table.querySelector("tbody");
  const rows  = Array.from(tbody.querySelectorAll("tr"));

  // √©tat de tri par table/colonne
  const key       = table.getAttribute("data-month-key") || "";
  const attrName  = `data-sort-${key}-${columnIndex}`;
  const current   = table.getAttribute(attrName) || "desc";
  const newOrder  = current === "asc" ? "desc" : "asc";
  const factor    = newOrder === "asc" ? 1 : -1;

  rows.sort((a, b) => {
    const ka = sortKeyFromCell(a.children[columnIndex], type);
    const kb = sortKeyFromCell(b.children[columnIndex], type);

    if (ka < kb) return -1 * factor;
    if (ka > kb) return  1 * factor;
    return 0;
  });

  rows.forEach(r => tbody.appendChild(r));
  table.setAttribute(attrName, newOrder);
}

document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll("table.archived-table").forEach((table, i) => {
    const thDate    = document.getElementById(`sort-date-${i+1}`);
    const thQui     = document.getElementById(`sort-qui-${i+1}`);
    const thMontant = document.getElementById(`sort-montant-${i+1}`);
    const thConcert = document.getElementById(`sort-concert-${i+1}`);

    if (thDate)    thDate   .addEventListener("click", () => sortTableByColumn(table, 0, 'date'));
    if (thQui)     thQui    .addEventListener("click", () => sortTableByColumn(table, 1, 'text'));
    if (thMontant) thMontant.addEventListener("click", () => sortTableByColumn(table, 5, 'amount'));
    if (thConcert) thConcert.addEventListener("click", () => sortTableByColumn(table, 6, 'concert'));
  });
});
</script>

{% endblock %}
