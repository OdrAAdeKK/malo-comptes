{% extends 'base.html' %}

{% block title %}Op√©rations archiv√©es - Saison {{ saison }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/archives_operations.css') }}">


<div class="container">
    <h1>Op√©rations archiv√©es - Saison {{ saison }}</h1>
    <button onclick="ouvrirPopupRecherche()" title="Rechercher une op√©ration" style="background:none; border:none; cursor:pointer;">üîç Recherche par montant</button>

    {% if operations %}
    <table class="archived-table">
        <thead>
            <tr>
                <th id="sort-date" style="cursor:pointer;">Date ‚¨ç</th>
                <th>Qui</th>
                <th>Type</th>
                <th>Motif</th>
                <th></th>
                <th id="sort-montant" style="cursor:pointer;">Montant ‚¨ç</th>
                <th>Concert</th>
                <th style="text-align: center;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for op in operations %}
            <tr class="{% if op.motif|lower == 'commission lionel' %}operation-auto{% endif %}">
                <td>{{ op.date.strftime('%d/%m/%Y') }}</td>
                <td>{{ op.musicien.prenom }} {{ op.musicien.nom }}</td>
                <td>{{ op.type }}</td>
                <td>{{ op.motif }}</td>
                <td>{{ op.precision or '' }}</td>
                <td>{{ "{:,.2f}".format(op.montant).replace(',', ' ').replace('.', ',') }} ‚Ç¨</td>
                <td>
                    {% if op.concert %}
                        {{ op.concert.date.strftime('%d/%m/%Y') }} ‚Äî {{ op.concert.lieu }}
                    {% else %}
                        ‚Äî
                    {% endif %}
                </td>
                <td style="text-align: center;">
                    {% if not op.auto_cb_asso7 and not op.auto_debit_salaire and op.motif|lower != 'commission lionel' %}
                        <form method="GET" action="{{ url_for('modifier_operation', id=op.id) }}" style="display:inline;">
                            <button type="submit" class="icon-button orange" title="Modifier">
                                <i class="fas fa-pen"></i>
                            </button>
                        </form>
                        <form method="POST" action="{{ url_for('supprimer_operation') }}" style="display:inline;" data-id="{{ op.id }}">
                            <button type="submit" class="delete-operation-button" title="Supprimer cette op√©ration">üóë</button>
                        </form>
                    {% else %}
                        <span title="Op√©ration automatique non modifiable">üîí</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
	<button id="btn-retour-liste" style="display:none; margin-top: 20px;" onclick="retourListe()">
    üîÅ Retour √† la liste compl√®te
</button>
    {% else %}
        <p>Aucune op√©ration enregistr√©e pour cette saison.</p>
    {% endif %}

    <div class="button-row">
        <a href="{{ url_for('accueil') }}" class="back-button">Accueil</a>
        <a href="#" onclick="if (document.referrer) { window.history.back(); } else { window.location.href='{{ url_for('accueil') }}'; }" class="retour-button">‚¨Ö Retour</a>
        <a href="{{ url_for('page_archives') }}" class="archives-button">Archives</a>
        <a href="{{ url_for('operations_a_venir') }}" class="a-venir-button">√Ä venir</a>
        <a href="{{ url_for('operations') }}" class="operations-button">Nouvelle op√©ration</a>
    </div>
</div>

{% include '_popup_recherche.html' %}

<script src="{{ url_for('static', filename='js/supprimer_operation.js') }}"></script>
<script src="{{ url_for('static', filename='js/recherche_operations.js') }}"></script>

<script>
function sortTableByColumn(table, columnIndex, numeric = false) {
    const tbody = table.querySelector("tbody");
    const rows = Array.from(tbody.querySelectorAll("tr"));
    const currentOrder = table.getAttribute(`data-sort-${columnIndex}`) || "desc";
    const newOrder = currentOrder === "asc" ? "desc" : "asc";

    rows.sort((a, b) => {
        let valA = a.children[columnIndex].innerText.trim();
        let valB = b.children[columnIndex].innerText.trim();

        if (numeric) {
            valA = parseFloat(valA.replace(',', '.').replace(/[^\d.-]/g, ''));
            valB = parseFloat(valB.replace(',', '.').replace(/[^\d.-]/g, ''));
        } else {
            const [dA, mA, yA] = valA.split("/");
            const [dB, mB, yB] = valB.split("/");
            valA = new Date(`${yA}-${mA}-${dA}`);
            valB = new Date(`${yB}-${mB}-${dB}`);
        }

        return newOrder === "asc" ? valA - valB : valB - valA;
    });

    rows.forEach(row => tbody.appendChild(row));
    table.setAttribute(`data-sort-${columnIndex}`, newOrder);
}

document.addEventListener("DOMContentLoaded", () => {
    const table = document.querySelector(".archived-table");
    document.getElementById("sort-date").addEventListener("click", () => sortTableByColumn(table, 0, false));
    document.getElementById("sort-montant").addEventListener("click", () => sortTableByColumn(table, 5, true));
});
</script>
{% endblock %}
