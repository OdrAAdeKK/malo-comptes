{% extends 'base.html' %}

{% block title %}Op√©rations √† venir{% endblock %}

{% block content %}
<style>
    .icon-button {
        border: none;
        background: none;
        cursor: pointer;
        font-size: 1.1rem;
        padding: 6px;
    }
    .icon-button.orange { color: #E67E22; }
    .icon-button.red { color: #C0392B; }

    /* ‚úì √©largir la page comme les concerts */
    .container.ops-a-venir {
        max-width: 1200px;
        width: 100%;
    }

    .archived-table { 
        width: 100%; 
        border-collapse: collapse; 
        margin-top: 20px; 
        font-size: 1rem; 
        table-layout: auto;
    }
    .archived-table thead th {
        background-color: #26bfa6 !important;
        color: white;
        font-weight: bold;
    }
    .archived-table th, .archived-table td {
        padding: 10px 14px;
        border: 1px solid #e0e0e0;
        text-align: left;
    }
    .archived-table tbody tr:nth-child(even) { background-color: #f9f9f9; }
    .archived-table tbody tr:hover { background-color: #e6f8f5; }

    /* ‚úì op√©rations auto + pr√©visionnels */
    tr.operation-auto { background-color: #f3f3f3; color: #666; font-style: italic; }
    tr.operation-auto td { border-top: 1px solid #ddd; }
    .mois-bandeau { margin-top: 30px; padding: 8px; background: #f0f0f0; font-weight: bold; border-radius: 4px; font-size: 1.2rem; }
    tr.is-previsionnel { background: #fafafa; }
    .muted-italic { color: #6b7280; font-style: italic; }
    .prev-tag { color: #6b7280; font-style: italic; margin-left: 6px; font-size: .9em; }

	/* largeur pr√©cise des colonnes (index du tableau) */
	.container.ops-a-venir .archived-table th:nth-child(6),
	.container.ops-a-venir .archived-table td:nth-child(6) {
	  width: 12.5ch;            /* Montant ~12 caract√®res */
	  min-width: 12.5ch;
	  max-width: 12.5ch;
	  white-space: nowrap;
	  text-align: right;
	  font-variant-numeric: tabular-nums;
	}

	/* R√©√©quilibrage : plus d‚Äôespace pour Qui / Motif / Pr√©cision, un peu moins pour Concert */
	.container.ops-a-venir .archived-table th:nth-child(2),
	.container.ops-a-venir .archived-table td:nth-child(2) {
	  width: 18%;               /* Qui */
	}

	.container.ops-a-venir .archived-table th:nth-child(4),
	.container.ops-a-venir .archived-table td:nth-child(4) {
	  width: 14%;               /* Motif */
	}

	.container.ops-a-venir .archived-table th:nth-child(5),
	.container.ops-a-venir .archived-table td:nth-child(5) {
	  width: 22%;               /* Pr√©cision */
	  word-break: break-word;   /* au cas o√π */
	}

	.container.ops-a-venir .archived-table th:nth-child(7),
	.container.ops-a-venir .archived-table td:nth-child(7) {
	  width: 28%;               /* Concert (r√©duit depuis 40%) */
	}

</style>

<div class="container ops-a-venir">
    <h1>Op√©rations √† venir</h1>

    {% if groupes %}
        {% for key, bloc in groupes.items() %}
    <h2>{{ bloc.label }}</h2>
    <table class="archived-table">
		<thead>
		  <tr>
			<th id="sort-date-{{ loop.index }}" style="cursor:pointer;">Date ‚¨ç</th>
			<th id="sort-qui-{{ loop.index }}" style="cursor:pointer;">Qui ‚¨ç</th>
			<th>Type</th>
			<th>Motif</th>
			<th>Pr√©cision</th>
			<th id="sort-montant-{{ loop.index }}" style="cursor:pointer; text-align:right;">Montant ‚¨ç</th>
			<th id="sort-concert-{{ loop.index }}" style="cursor:pointer;">Concert ‚¨ç</th>
			<th style="text-align: center;">Actions</th>
		  </tr>
		</thead>

        <tbody>
            {% for op in bloc["items"] %}
            <tr class="{% if op.motif|lower == 'commission lionel' %}operation-auto {% endif %}{% if op.previsionnel %}is-previsionnel{% endif %}">
                <td>
                  {{ op.date.strftime('%d/%m/%Y') }}
                  {% if op.previsionnel %}<em class="prev-tag">(pr√©visionnel)</em>{% endif %}
                </td>
                <td>{{ op.musicien.prenom }} {{ op.musicien.nom }}</td>
                <td>{{ op.type }}</td>
                <td>{{ op.motif }}</td>
                <td>{{ op.precision or '' }}</td>
                <td class="col-amount">
                  <span class="{% if op.previsionnel %}muted-italic{% endif %}">
                    {{ "{:,.2f}".format(op.montant).replace(',', ' ').replace('.', ',') }} ‚Ç¨
                  </span>
                </td>
                <td>
                    {% if op.concert %}
                        {{ op.concert.date.strftime('%d/%m/%Y') }} ‚Äî {{ op.concert.lieu }}
                    {% else %}‚Äî{% endif %}
                </td>
                <td style="text-align: center;">
                    {% if op.motif|lower != 'commission lionel' %}
                        <form method="GET" action="{{ url_for('modifier_operation', id=op.id) }}" style="display:inline;">
                            <button type="submit" class="icon-button orange" title="Modifier">
                                <i class="fas fa-pen"></i>
                            </button>
                        </form>
                        <form method="POST" action="{{ url_for('supprimer_operation') }}" style="display:inline;" data-id="{{ op.id }}">
                            <button type="submit" class="delete-operation-button" title="Supprimer cette op√©ration">üóë</button>
                        </form>
                    {% else %}
                        <span title="Op√©ration automatique non modifiable">üîí</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endfor %}

    {% else %}
        <p>Aucune op√©ration √† venir.</p>
    {% endif %}

    <div class="button-row">
        <a href="{{ url_for('accueil') }}" class="back-button">Accueil</a>
        <a href="#" onclick="if (document.referrer) { window.history.back(); } else { window.location.href='{{ url_for('accueil') }}'; }" class="retour-button">‚¨Ö Retour</a>
        <a href="{{ url_for('archives_operations') }}" class="archives-button">Archives</a>
        <a href="{{ url_for('comptes') }}" class="valider-button">Comptes</a>
        <a href="{{ url_for('operations') }}" class="operations-button">Nouvelle op√©ration</a>
    </div>
</div>

<script src="{{ url_for('static', filename='js/supprimer_operation.js') }}"></script>

<script>
function norm(s){return (s||"").toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();}

function sortKeyFromCell(td, type){
  const raw=(td.innerText||td.textContent||'').trim();
  if(type==='date'){
    const m=raw.match(/^(\d{2})\/(\d{2})\/(\d{4})/);
    if(!m) return -Infinity;
    return new Date(`${m[3]}-${m[2]}-${m[1]}`).getTime();
  }
  if(type==='amount'){
    return parseFloat(raw.replace(/\s/g,'').replace('‚Ç¨','').replace(',', '.').replace(/[^\d.\-+]/g,''))||0;
  }
  if(type==='concert'){
    if(raw==='‚Äî'||raw==='-') return '';
    const parts=raw.split('‚Äî');
    const lieu=(parts.length>1?parts.slice(1).join('‚Äî'):raw);
    return norm(lieu);
  }
  return norm(raw);
}

function sortTableByColumn(table, columnIndex, type){
  const tbody=table.querySelector("tbody");
  const rows=Array.from(tbody.querySelectorAll("tr"));
  const key=table.getAttribute("data-month-key")||"";
  const attrName=`data-sort-${key}-${columnIndex}`;
  const current=table.getAttribute(attrName)||"desc";
  const newOrder=current==="asc"?"desc":"asc";
  const factor=newOrder==="asc"?1:-1;

  rows.sort((a,b)=>{
    const ka=sortKeyFromCell(a.children[columnIndex], type);
    const kb=sortKeyFromCell(b.children[columnIndex], type);
    if(ka<kb) return -1*factor;
    if(ka>kb) return  1*factor;
    return 0;
  });

  rows.forEach(r=>tbody.appendChild(r));
  table.setAttribute(attrName, newOrder);
}

document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll("table.archived-table").forEach((table, i) => {
    const thDate    = document.getElementById(`sort-date-${i+1}`);
    const thQui     = document.getElementById(`sort-qui-${i+1}`);
    const thMontant = document.getElementById(`sort-montant-${i+1}`);
    const thConcert = document.getElementById(`sort-concert-${i+1}`);

    if (thDate)    thDate   .addEventListener("click", () => sortTableByColumn(table, 0, 'date'));
    if (thQui)     thQui    .addEventListener("click", () => sortTableByColumn(table, 1, 'text'));
    if (thMontant) thMontant.addEventListener("click", () => sortTableByColumn(table, 5, 'amount'));
    if (thConcert) thConcert.addEventListener("click", () => sortTableByColumn(table, 6, 'concert'));
  });
});
</script>

{% endblock %}
