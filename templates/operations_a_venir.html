{% extends 'base.html' %}

{% block title %}OpÃ©rations Ã  venir{% endblock %}

{% block content %}
<style>
    .icon-button {
        border: none;
        background: none;
        cursor: pointer;
        font-size: 1.1rem;
        padding: 6px;
    }
    .icon-button.orange {
        color: #E67E22;
    }
    .icon-button.red {
        color: #C0392B;
    }
    .archived-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        font-size: 1rem;
    }
    .archived-table thead th {
        background-color: #26bfa6 !important;
        color: white;
        font-weight: bold;
    }
    .archived-table th, .archived-table td {
        padding: 10px 14px;
        border: 1px solid #e0e0e0;
        text-align: left;
    }
    .archived-table tbody tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    .archived-table tbody tr:hover {
        background-color: #e6f8f5;
    }

    tr.operation-auto {
        background-color: #f3f3f3;
        color: #666;
        font-style: italic;
    }
    tr.operation-auto td {
        border-top: 1px solid #ddd;
    }
    .mois-bandeau {
        margin-top: 30px;
        padding: 8px;
        background: #f0f0f0;
        font-weight: bold;
        border-radius: 4px;
        font-size: 1.2rem;
    }
</style>

<div class="container">
    <h1>OpÃ©rations Ã  venir</h1>

    {% if groupes %}
        {% for key, bloc in groupes.items() %}
    <h2>{{ bloc.label }}</h2>
    <table class="archived-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Qui</th>
                <th>Type</th>
                <th>Motif</th>
                <th></th>
                <th>Montant</th>
                <th>Concert</th>
                <th style="text-align: center;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for op in bloc["items"] %}
            <tr class="{% if op.motif|lower == 'commission lionel' %}operation-auto{% endif %}">
                <td>{{ op.date.strftime('%d/%m/%Y') }}</td>
                <td>{{ op.musicien.prenom }} {{ op.musicien.nom }}</td>
                <td>{{ op.type }}</td>
                <td>{{ op.motif }}</td>
                <td>{{ op.precision or '' }}</td>
                <td>{{ "{:,.2f}".format(op.montant).replace(',', ' ').replace('.', ',') }} â‚¬</td>
                <td>
                    {% if op.concert %}
                        {{ op.concert.date.strftime('%d/%m/%Y') }} â€” {{ op.concert.lieu }}
                    {% else %}
                        â€”
                    {% endif %}
                </td>
                <td style="text-align: center;">
                    {% if op.motif|lower != 'commission lionel' %}
                        <form method="GET" action="{{ url_for('modifier_operation', id=op.id) }}" style="display:inline;">
                            <button type="submit" class="icon-button orange" title="Modifier">
                                <i class="fas fa-pen"></i>
                            </button>
                        </form>
                        <form method="POST" action="{{ url_for('supprimer_operation') }}" style="display:inline;" data-id="{{ op.id }}">
                            <button type="submit" class="delete-operation-button" title="Supprimer cette opÃ©ration">ðŸ—‘</button>
                        </form>
                    {% else %}
                        <span title="OpÃ©ration automatique non modifiable">ðŸ”’</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endfor %}

    {% else %}
        <p>Aucune opÃ©ration Ã  venir.</p>
    {% endif %}

    <div class="button-row">
        <a href="{{ url_for('accueil') }}" class="back-button">Accueil</a>
        <a href="#" onclick="if (document.referrer) { window.history.back(); } else { window.location.href='{{ url_for('accueil') }}'; }" class="retour-button">â¬… Retour</a>
        <a href="{{ url_for('archives_operations') }}" class="archives-button">Archives</a>
        <a href="{{ url_for('comptes') }}" class="valider-button">Comptes</a>
        <a href="{{ url_for('operations') }}" class="operations-button">Nouvelle opÃ©ration</a>
    </div>
</div>

<script src="{{ url_for('static', filename='js/supprimer_operation.js') }}"></script>

<script>
function sortTableByColumn(table, columnIndex, numeric = false) {
    const tbody = table.querySelector("tbody");
    const rows = Array.from(tbody.querySelectorAll("tr"));
    const key = table.getAttribute("data-month-key") || "";
    const attrName = `data-sort-${key}-${columnIndex}`;
    const currentOrder = table.getAttribute(attrName) || "desc";
    const newOrder = currentOrder === "asc" ? "desc" : "asc";

    rows.sort((a, b) => {
        let valA = a.children[columnIndex].innerText.trim();
        let valB = b.children[columnIndex].innerText.trim();

        if (numeric) {
            valA = parseFloat(valA.replace(/\s/g,'').replace('â‚¬','').replace(',', '.').replace(/[^\d\.\-+]/g,''));
            valB = parseFloat(valB.replace(/\s/g,'').replace('â‚¬','').replace(',', '.').replace(/[^\d\.\-+]/g,''));
        } else {
            const [dA, mA, yA] = valA.split("/");
            const [dB, mB, yB] = valB.split("/");
            valA = new Date(`${yA}-${mA}-${dA}`).getTime();
            valB = new Date(`${yB}-${mB}-${dB}`).getTime();
        }
        return (newOrder === "asc") ? (valA - valB) : (valB - valA);
    });

    rows.forEach(row => tbody.appendChild(row));
    table.setAttribute(attrName, newOrder);
}

document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("table.archived-table").forEach((table, i) => {
        const thDate = document.getElementById(`sort-date-${i+1}`);
        const thMont = document.getElementById(`sort-montant-${i+1}`);
        if (thDate) thDate.addEventListener("click", () => sortTableByColumn(table, 0, false));
        if (thMont) thMont.addEventListener("click", () => sortTableByColumn(table, 5, true));
    });
});
</script>
{% endblock %}
