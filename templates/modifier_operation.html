<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Modifier une opÃ©ration</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
    <style>
        .operations-form-container {
            background: #fff;
            padding: 36px;
            border-radius: 16px;
            box-shadow: 0 0 18px rgba(50,60,100,0.07);
            max-width: 650px;
            margin: 48px auto 0;
        }
        .operations-form-title {
            font-size: 3.05em;
            font-weight: 800;
            color: #23243b;
            margin-bottom: 32px;
            text-align: center;
        }
        .form-row-flex, .form-actions-row {
            display: flex;
            gap: 32px;
            justify-content: space-between;
            margin-bottom: 18px;
        }
        .form-row-flex > div {
            flex: 1;
        }
        .radio-group {
            display: flex;
            gap: 32px;
            align-items: center;
            margin-bottom: 18px;
            margin-top: 6px;
        }
		.montant-triple-row {
			display: flex;
			justify-content: space-between;
			gap: 20px;
			margin-bottom: 18px;
			flex-wrap: wrap;
		}
		.montant-triple-row {
			display: flex;
			justify-content: space-between;
			gap: 20px;
			margin-bottom: 18px;
		}

		.montant-triple-row > .montant-col {
			flex: 0 0 28%;
		}

		.montant-triple-row > .brut-col {
			flex: 0 0 28%;
		}

		.montant-triple-row > .concert-col {
			flex: 0 0 42%;
		}

		.concert-autocomplete-wrapper {
			position: relative;
			max-width: 100%;
		}
        label {
            font-size: 1.25em;
            margin-bottom: 6px;
            font-weight: 600;
        }
        input, select {
            width: 100%;
            padding: 12px 9px;
            font-size: 1.1em;
            border-radius: 7px;
            border: 1px solid #d2d2d7;
            background: #fafafd;
            margin-bottom: 3px;
        }
        #calendar_icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 1.25em;
        }
        .btn-big {
            width: 100%;
            font-size: 1.1em;
            padding: 14px 0;
            border-radius: 10px;
            text-align: center;
        }
		.triple-field-row {
		  display: flex;
		  justify-content: space-between;
		  gap: 20px;
		  margin-bottom: 24px;
		  align-items: flex-start;
		}

		.field-col {
		  display: flex;
		  flex-direction: column;
		}

		.field-col.small {
		  flex: 1;
		  min-width: 0;
		}

		.field-col.large {
		  flex: 2;
		  min-width: 0;
		}

		.field-col input {
		  width: 100%;
		}

		.concert-autocomplete-wrapper {
		  position: relative;
		  width: 100%;
		}
		.field-col label {
		  margin-bottom: 6px;
		  font-weight: 600; /* optionnel pour lisibilitÃ© */
		}
		label[for="montant"] {
		  margin-bottom: 28px;
		  display: inline-block;
		}
		label[for="concert_field"] {
		  margin-bottom: 28px;
		  display: inline-block;
		}
		#montant {
		  width: 120px; /* ajuste selon ton besoin */
		}
		#brut {
		  width: 120px; /* ajuste selon ton besoin */
		}		

    </style>
</head>
<body>
<div class="operations-form-container">
    <form method="POST" action="{{ url_for('modifier_operation', id=operation.id) }}">
    <div class="form-row-flex">
      <div>
        <label for="musicien">Qui&nbsp;?</label>
        <select name="musicien" id="musicien" required>
          <option value="">-- SÃ©lectionner --</option>
          {% for musicien in musiciens_normaux %}
            {% set nom_complet = (musicien['prenom'] ~ ' ' ~ musicien['nom']).strip() %}
            <option value="{{ nom_complet }}"
              {% if operation and nom_complet == operation.musicien.prenom ~ ' ' ~ operation.musicien.nom %}selected{% endif %}>
              {{ nom_complet }}
            </option>
          {% endfor %}
          <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
          {% for musicien in structures %}
            {% set nom_complet = (musicien['prenom'] ~ ' ' ~ musicien['nom']).strip() %}
            <option value="{{ nom_complet }}" class="structure-option" style="color:#ab27b9;font-weight:bold;"
              {% if operation and nom_complet == operation.musicien.prenom ~ ' ' ~ operation.musicien.nom %}selected{% endif %}>
              {{ nom_complet }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="date">Date :</label>
        <input type="text" name="date" id="date"
               value="{{ operation.date.strftime('%d/%m/%Y') if operation else current_date }}" required>
      </div>
    </div>

    <div>
      <label>Type d'opÃ©ration :</label>
      <div class="radio-group">
        <label><input type="radio" id="credit_radio" name="type_visible" value="credit"
          {% if operation and operation.type == 'credit' %}checked{% endif %}> CrÃ©dit</label>
        <label><input type="radio" id="debit_radio" name="type_visible" value="debit"
          {% if operation and operation.type == 'debit' %}checked{% endif %}> DÃ©bit</label>
        <input type="hidden" name="type" id="type_hidden" value="{{ operation.type if operation else '' }}">
      </div>
    </div>

    <div class="form-row-flex">
      <div>
        <label for="motif">Motif</label>
        <select id="motif" name="motif" required>
          <option value="Salaire" {% if operation and operation.motif == "Salaire" %}selected{% endif %}>Salaire</option>
          <option value="Frais" {% if operation and operation.motif == "Frais" %}selected{% endif %}>Frais</option>
          <option value="Achat" {% if operation and operation.motif == "Achat" %}selected{% endif %}>Achat</option>
          <option value="Vente" {% if operation and operation.motif == "Vente" %}selected{% endif %}>Vente</option>
          <option value="Recette concert" {% if operation and operation.motif == "Recette concert" %}selected{% endif %}>Recette concert</option>
          <option value="Remboursement frais divers" {% if operation and operation.motif == "Remboursement frais divers" %}selected{% endif %}>
            Remboursement frais divers
          </option>
        </select>
      </div>
      <div>
        <label for="precision">PrÃ©cisez</label>
        <input type="text" id="precision" name="precision"
               placeholder="Ex. : transport, avance, matÃ©rielâ€¦"
               value="{{ operation.precision if operation else '' }}">
      </div>
    </div>

    <div class="triple-field-row">
      <div class="field-col small">
        <label for="montant">Montant (â‚¬) :</label>
        <input type="number" name="montant" id="montant" step="0.01" required
               value="{{ operation.montant if operation else '' }}">
      </div>
      <div class="field-col small">
        <label for="brut">Brut (salaires uniquement) :</label>
        <input type="number" name="brut" id="brut" step="0.01"
               value="{{ operation.brut if operation and operation.brut else '' }}">
      </div>
      <div class="field-col large">
        <label for="concert_field">Concert liÃ© :</label>
        <div class="concert-autocomplete-wrapper" style="position:relative;">
          <!-- Champ visible pour lâ€™utilisateur -->
          <input type="text" id="concert_field" name="concert_field"
                 placeholder="JJ/MM/AAAA â€” Lieu" autocomplete="off"
                 value="{% if operation and operation.concert %}{{ operation.concert.date.strftime('%d/%m/%Y') ~ ' â€” ' ~ operation.concert.lieu }}{% endif %}">
          <!-- Input cachÃ© pour Flatpickr (concert liÃ©) -->
          <input type="text" id="concert_date_picker" style="display:none">
          <!-- Hidden ID concert -->
          <input type="hidden" id="concert_id" name="concert_id"
                 value="{{ operation.concert.id if operation and operation.concert else '' }}">
          <!-- IcÃ´ne calendrier -->
          <span id="calendar_icon"
                style="position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; font-size:1.25em;">ðŸ“…</span>
          <!-- Liste autocomplete -->
          <div id="concert_autocomplete" class="autocomplete-list"
               style="position:absolute; left:0; right:0; top:100%; z-index:10; background:white; border:1px solid #bbb; display:none;"></div>
        </div>
      </div>
    </div>

    <div class="button-row">
      <button type="submit" class="valider-button" style="width: 100%; max-width: 700px;">Valider</button>
    </div>
    <div class="button-row">
      <a href="{{ url_for('accueil') }}" class="back-button">Accueil</a>
      <a href="#" onclick="if (document.referrer) { window.history.back(); } else { window.location.href='{{ url_for('accueil') }}'; }" class="retour-button">â¬… Retour</a>
      <a href="{{ url_for('page_archives') }}" class="archives-button">Archives</a>
      <a href="{{ url_for('operations_a_venir') }}" class="a-venir-button">Ã€ venir</a>
    </div>
    </form>
</div>

<!-- DonnÃ©es pour le JS -->
<script>window.concerts = {{ concerts_js | tojson | safe }};</script>
<script>window.concertsParMusicien = {{ concerts_par_musicien | tojson | safe }};</script>

<!-- Bundle (gÃ¨re motifs, type, brut, calendrier & autocomplete) -->
<script src="{{ url_for('static', filename='js/operations.js') }}"></script>
</body>

</html>